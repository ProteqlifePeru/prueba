<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìû Dashboard Llamadas 107 - ESSALUD</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://kit.fontawesome.com/a2d04b6a6a.js" crossorigin="anonymous"></script>

<style>
:root {
  --primary: #0066cc;
  --secondary: #00a859;
  --accent: #e7f1ff;
  --bg: linear-gradient(135deg,#d0e7ff,#f0f9ff);
  --text: #222;
  --card-bg: #fff;
  --radius: 16px;
  --shadow: 0 12px 40px rgba(0,0,0,0.15);
}

* {box-sizing:border-box;}
body {
  font-family:'Poppins',sans-serif;
  margin:0; padding:0;
  background: var(--bg);
  display:flex; justify-content:center; min-height:100vh;
}

.container {
  width: 80%;           /* reducido para que no se vea gigante */
  max-width: 1000px;
  margin: 40px auto;
  padding: 20px;
}

h1 {
  text-align:center;
  color: var(--primary);
  font-size:28px;
  font-weight:700;
  margin-bottom:30px;
  text-shadow:1px 1px 2px rgba(0,0,0,0.1);
}

.card {
  background: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding:20px 25px;
  margin-bottom:25px;
  transition: transform 0.3s, box-shadow 0.3s;
}
.card:hover {transform: translateY(-5px); box-shadow:0 20px 50px rgba(0,0,0,0.25);}

.section-title {
  margin-top:20px;
  margin-bottom:10px;
  font-size:20px;
  font-weight:600;
  color: var(--primary);
  border-left:5px solid var(--primary);
  padding-left:10px;
  display:flex; align-items:center; gap:8px;
}

label {display:block; margin-top:12px; font-weight:500; font-size:14px;}

input, select {
  width:100%;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #ccc;
  font-size:14px;
  transition:0.3s;
}
input:focus, select:focus {
  outline:none; border-color: var(--primary);
  box-shadow:0 0 8px rgba(0,102,204,0.3);
  background: var(--accent);
}
input[readonly], select[readonly] {background:#f0f0f0;}

#nombreCompleto {
  font-size:20px;
  font-weight:700;
  color:#000;
  text-align:center;
  border:2px solid #ccc;
  border-radius:14px;
  padding:10px;
  transition:0.3s;
}

.flex {display:flex; gap:15px; flex-wrap:wrap;}
.flex-2 > div, .flex-3 > div {flex:1;}
.flex-3 > div {min-width:150px;}

button {
  padding:12px;
  background: var(--secondary);
  color:white;
  border:none;
  border-radius:14px;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
  transition:0.3s;
}
button:hover {
  transform: translateY(-2px);
  box-shadow:0 5px 20px rgba(0,0,0,0.2);
}
#btnLimpiar {background:#cc0000;}
#btnLimpiar:hover {background:#990000;}

.info-bar {
  background: #b0dbff;
  color: var(--primary);
  padding:10px 12px;
  border-radius:12px;
  font-size:16px;
  font-weight:600;
  margin-bottom:15px;
  text-align:center;
}

.alert {
  padding: 10px 15px;
  border-radius:12px;
  margin:10px 0;
  font-weight:600;
  text-align:center;
  display:none;
}

.alert.error {background:#f8d7da; color:#721c24;}
.alert.success {background:#d0f2e0; color:#155724;}

@media(max-width:1000px){ h1{font-size:26px;} #nombreCompleto{font-size:18px;} }
@media(max-width:600px){ .flex{flex-direction:column;} }
</style>
</head>
<body>

<div class="container">
<h1><i class="fas fa-phone-volume"></i> Dashboard Llamadas 107 - ESSALUD</h1>

<div class="card">
  <div class="info-bar" id="estadoConexion">Buscando conexi√≥n con el servidor... üåê</div>
  <div class="alert" id="alerta"></div>
  <div id="contadorDuracion"></div>

  <label>Fecha y hora de inicio ‚è±Ô∏è</label>
  <input type="text" id="fechaInicio" readonly>

  <div class="section-title"><i class="fas fa-user-md"></i> Datos del Profesional</div>
  <div class="flex flex-2">
    <div>
      <label>Profesi√≥n</label>
      <select id="profesion">
        <option value="">Seleccione...</option>
      </select>
    </div>
    <div>
      <label>Personal</label>
      <select id="personal">
        <option value="">Seleccione...</option>
        <option>Juan</option>
        <option>Pedro</option>
        <option>Carlos</option>
      </select>
    </div>
  </div>

  <div class="section-title"><i class="fas fa-phone"></i> Datos de la Llamada</div>
  <label>Opciones de llamada üìû</label>
  <select id="opcionLlamada">
    <option value="">Seleccione...</option>
    <option>Opci√≥n 0 - Informaci√≥n sobre vacunaci√≥n</option>
    <option>Opci√≥n 1 - Informaci√≥n medicina general</option>
    <option>Opci√≥n 2 - L√≠nea del paciente cr√≥nico</option>
    <option>Opci√≥n 3 - Informaci√≥n en psicolog√≠a</option>
    <option>Opci√≥n 4 - Asesor√≠a en nutrici√≥n</option>
    <option>Opci√≥n 5 - Enfermedades varias</option>
    <option>Opci√≥n 6 - Casos de violencia contra la mujer</option>
    <option>Opci√≥n 7 - Atenci√≥n a personas vulnerables</option>
    <option>Opci√≥n 8 - L√≠nea del donante</option>
    <option>Opci√≥n 9 - Oncol√≠nea ESSALUD</option>
    <option>LLAMADAS MAL INTENCIONADAS</option>
  </select>

  <label>N√∫mero de tel√©fono üì±</label>
  <input type="tel" id="telefono" placeholder="Ej. 987654321">

  <div class="section-title"><i class="fas fa-user"></i> Datos del Paciente</div>
  <div class="flex flex-2">
    <div>
      <label>Tipo de documento üÜî</label>
      <select id="tipoDoc">
        <option value="DNI" selected>DNI</option>
        <option>CE</option>
        <option>PASS</option>
        <option>C√âDULA</option>
        <option>AN√ìNIMO</option>
      </select>
    </div>
    <div>
      <label>N¬∞ Documento</label>
      <input type="text" id="dni" maxlength="12" placeholder="Ingrese el n√∫mero">
    </div>
  </div>

  <label>Nombre completo üë§</label>
  <input type="text" id="nombreCompleto" readonly>

  <div class="flex flex-2">
    <div>
      <label>Sexo</label>
      <select id="sexo" readonly>
        <option value="">Seleccione...</option>
        <option>M</option>
        <option>F</option>
      </select>
    </div>
    <div>
      <label>Fecha de nacimiento üìÖ</label>
      <input type="date" id="fechaNac" readonly>
    </div>
  </div>

  <label>Edad actual üßÆ</label>
  <input type="text" id="edad" readonly>

  <div class="section-title"><i class="fas fa-map-marker-alt"></i> Ubicaci√≥n üó∫Ô∏è</div>
  <div class="flex flex-3">
    <div>
      <label>Departamento</label>
      <select id="departamento">
        <option value="">Seleccione...</option>
        <option>Lima</option>
        <option>Cusco</option>
        <option>Arequipa</option>
      </select>
    </div>
    <div>
      <label>Provincia</label>
      <select id="provincia">
        <option value="">Seleccione...</option>
      </select>
    </div>
    <div>
      <label>Distrito</label>
      <select id="distrito">
        <option value="">Seleccione...</option>
      </select>
    </div>
  </div>

  <label>Fecha y hora de t√©rmino ‚è∞</label>
  <input type="text" id="fechaTermino" readonly>

  <div class="flex" style="gap:10px; margin-top:20px;">
    <button id="btnGuardar"><i class="fas fa-save"></i> Guardar Registro</button>
    <button id="btnLimpiar"><i class="fas fa-eraser"></i> Limpiar Todo</button>
  </div>

</div>
</div>

<script>
// ---------- FECHA DE INICIO ----------
const fechaInicio = document.getElementById('fechaInicio');
const fechaTermino = document.getElementById('fechaTermino');
const estado = document.getElementById('estadoConexion');
const nombreCompleto = document.getElementById('nombreCompleto');
const alerta = document.getElementById('alerta');
fechaInicio.value = formatoFecha(new Date());

function formatoFecha(f){
  const d = String(f.getDate()).padStart(2,'0');
  const m = String(f.getMonth()+1).padStart(2,'0');
  const y = f.getFullYear();
  const h = String(f.getHours()).padStart(2,'0');
  const min = String(f.getMinutes()).padStart(2,'0');
  const s = String(f.getSeconds()).padStart(2,'0');
  return `${d}_${m}_${y} ${h}:${min}:${s}`;
}

// ---------- CONTADOR DE DURACI√ìN ----------
let inicioLlamada = new Date();
const contador = document.getElementById('contadorDuracion');

function actualizarContador(){
  const ahora = new Date();
  let diff = Math.floor((ahora - inicioLlamada) / 1000);
  const h = String(Math.floor(diff / 3600)).padStart(2,'0');
  diff %= 3600;
  const m = String(Math.floor(diff / 60)).padStart(2,'0');
  const s = String(diff % 60).padStart(2,'0');
  contador.textContent = `‚è±Ô∏è Duraci√≥n de la llamada: ${h}:${m}:${s}`;
}
setInterval(actualizarContador,1000);

// ---------- PERSONAL PERMANENTE ----------
const personalSelect = document.getElementById('personal');
const profesionSelect = document.getElementById('profesion');
const personalLista = {"Juan":"M√©dico","Pedro":"Enfermero","Carlos":"M√©dico"};

window.addEventListener('load', () => {
  const usuarioGuardado = localStorage.getItem('usuarioActivo');
  if(usuarioGuardado){
    personalSelect.value = usuarioGuardado;
    profesionSelect.value = personalLista[usuarioGuardado] || '';
    personalSelect.disabled = true;
    profesionSelect.disabled = true;
  }
});

personalSelect.addEventListener('change', () => {
  const nombre = personalSelect.value;
  if(nombre){
    profesionSelect.value = personalLista[nombre] || '';
    localStorage.setItem('usuarioActivo', nombre);
    personalSelect.disabled = true;
    profesionSelect.disabled = true;
  }
});

const btnCerrarSesion = document.createElement('button');
btnCerrarSesion.textContent = "Cerrar sesi√≥n";
btnCerrarSesion.style.marginLeft = "10px";
btnCerrarSesion.style.padding = "8px 12px";
btnCerrarSesion.style.borderRadius = "10px";
btnCerrarSesion.style.background = "#cc0000";
btnCerrarSesion.style.color = "#fff";
btnCerrarSesion.style.border = "none";
btnCerrarSesion.style.cursor = "pointer";
document.querySelector('.container').prepend(btnCerrarSesion);

btnCerrarSesion.addEventListener('click', () => {
  localStorage.removeItem('usuarioActivo');
  personalSelect.disabled = false;
  profesionSelect.disabled = false;
  personalSelect.value = "";
  profesionSelect.value = "";
  inicioLlamada = new Date();
});

// ---------- B√öSQUEDA AUTOM√ÅTICA POR DNI ----------
document.getElementById('dni').addEventListener('input', async e => {
  const dni = e.target.value.trim();
  if(dni.length >= 8) await buscarDNI(dni);
});

async function buscarDNI(dni){
  const urls = [`http://172.20.60.152:8000/buscar/${dni}`];
  let data = null;
  for(const url of urls){
    try{
      const res = await fetch(url);
      if(res.ok){
        data = await res.json();
        estado.textContent = `‚úÖ Conectado: ${url}`;
        break;
      }
    }catch(e){}
  }

  if(data && (data.DNI || data.dni)){
    nombreCompleto.value = data.NOMBRE_COMPLETO || data.nombre_completo || '';
    nombreCompleto.style.background = '#d0f2e0';
    document.getElementById('sexo').value = data.SEXO || data.sexo || '';
    let fechaServer = data.FECHA_NAC || data.fecha_nacimiento || '';
    if(fechaServer){
      let parts = fechaServer.split(/[-/_]/);
      if(parts.length===3){
        let day = parts[0].padStart(2,'0');
        let month = parts[1].padStart(2,'0');
        let year = parts[2];
        document.getElementById('fechaNac').value = `${year}-${month}-${day}`;
      }
    }
    calcularEdad();
  } else {
    estado.textContent = '‚ö†Ô∏è No se encontr√≥ el DNI. Complete los datos manualmente.';
    nombreCompleto.value='';
    nombreCompleto.style.background='#f8d7da';
    document.getElementById('nombreCompleto').removeAttribute('readonly');
    document.getElementById('fechaNac').removeAttribute('readonly');
    document.getElementById('sexo').removeAttribute('readonly');
  }
}

// ---------- CALCULAR EDAD ----------
document.getElementById('fechaNac').addEventListener('change', calcularEdad);
function calcularEdad(){
  const fechaNac = new Date(document.getElementById('fechaNac').value);
  if(isNaN(fechaNac)) return;
  const hoy = new Date();
  let a√±os = hoy.getFullYear() - fechaNac.getFullYear();
  let meses = hoy.getMonth() - fechaNac.getMonth();
  let dias = hoy.getDate() - fechaNac.getDate();
  if(dias<0){ meses--; const mesAnt = new Date(hoy.getFullYear(), hoy.getMonth(),0); dias+=mesAnt.getDate();}
  if(meses<0){a√±os--;meses+=12;}
  document.getElementById('edad').value = `${a√±os} a√±os, ${meses} meses, ${dias} d√≠as`;
}

// ---------- VALIDACI√ìN Y GUARDAR REGISTRO ----------
document.getElementById('btnGuardar').addEventListener('click',()=>{
  alerta.style.display='none';
  const campos = [
    {id:'profesion', nombre:'Profesi√≥n'},
    {id:'personal', nombre:'Personal'},
    {id:'opcionLlamada', nombre:'Opci√≥n de llamada'},
    {id:'telefono', nombre:'Tel√©fono'},
    {id:'tipoDoc', nombre:'Tipo de documento'},
    {id:'dni', nombre:'N√∫mero de documento'},
    {id:'nombreCompleto', nombre:'Nombre completo'},
    {id:'sexo', nombre:'Sexo'},
    {id:'fechaNac', nombre:'Fecha de nacimiento'},
    {id:'departamento', nombre:'Departamento'},
    {id:'provincia', nombre:'Provincia'},
    {id:'distrito', nombre:'Distrito'}
  ];

  let errores = [];
  campos.forEach(c=>{
    const val = document.getElementById(c.id).value.trim();
    if(!val) errores.push(c.nombre);
  });

  if(errores.length>0){
    alerta.textContent = '‚ùå Complete: ' + errores.join(', ');
    alerta.className = 'alert error';
    alerta.style.display='block';
    return;
  }

  fechaTermino.value = formatoFecha(new Date());
  alerta.textContent = '‚úÖ Registro guardado correctamente.';
  alerta.className = 'alert success';
  alerta.style.display='block';
});

// ---------- LIMPIAR TODO ----------
document.getElementById('btnLimpiar').addEventListener('click',()=>{
  document.querySelectorAll('input').forEach(i=>i.value='');
  document.querySelectorAll('select').forEach(s=>{ s.selectedIndex = 0; });
  nombreCompleto.style.background='#fff';
  estado.textContent='Buscando conexi√≥n con el servidor...';
  inicioLlamada = new Date();
  alerta.style.display='none';
});

// ---------- UBICACI√ìN CONDICIONAL ----------
const provincias = {
  Lima:['Lima','Barranca','Canta'],
  Cusco:['Cusco','Urubamba','Sicuani'],
  Arequipa:['Arequipa','Camana','Caylloma']
};
const distritos = {
  Lima:{Lima:['Miraflores','San Isidro'],Barranca:['Paramonga','Supe'],Canta:['Canta','San Miguel']},
  Cusco:{Cusco:['Wanchaq','San Sebasti√°n'],Urubamba:['Ollantaytambo'],Sicuani:['Sicuani']},
  Arequipa:{Arequipa:['Cayma','Yanahuara'],Camana:['Caman√°','Oco√±a'],Caylloma:['Chivay','Cabanaconde']}
};
const deptoSel=document.getElementById('departamento');
const provSel=document.getElementById('provincia');
const distSel=document.getElementById('distrito');

deptoSel.addEventListener('change',()=>{
  provSel.innerHTML='<option value="">Seleccione...</option>';
  distSel.innerHTML='<option value="">Seleccione...</option>';
  const provs=provincias[deptoSel.value]||[];
  provs.forEach(p=>{let opt=document.createElement('option');opt.textContent=p;provSel.appendChild(opt);});
});
provSel.addEventListener('change',()=>{
  distSel.innerHTML='<option value="">Seleccione...</option>';
  const dists=(distritos[deptoSel.value]||{})[provSel.value]||[];
  dists.forEach(d=>{let opt=document.createElement('option');opt.textContent=d;distSel.appendChild(opt);});
});
</script>

</body>
</html>
